name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # ── Desktop: macOS ───────────────────────────────────────────────────────────
  release-macos:
    name: Release macOS
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workdir: clients/desktop/src-tauri

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            clients/web/package-lock.json
            clients/desktop/package-lock.json

      - name: Install dependencies
        run: |
          npm ci --prefix clients/web
          npm ci --prefix clients/desktop

      - name: Build desktop app (unsigned)
        run: npm run build
        working-directory: clients/desktop

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: clients/desktop/src-tauri/target/release/bundle/dmg/*.dmg

  # ── Desktop: Windows ────────────────────────────────────────────────────────
  release-windows:
    name: Release Windows
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workdir: clients/desktop/src-tauri

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            clients/web/package-lock.json
            clients/desktop/package-lock.json

      - name: Install dependencies
        run: |
          npm ci --prefix clients/web
          npm ci --prefix clients/desktop

      - name: Build desktop app (unsigned)
        run: npm run build
        working-directory: clients/desktop

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            clients/desktop/src-tauri/target/release/bundle/msi/*.msi
            clients/desktop/src-tauri/target/release/bundle/nsis/*.exe

  # ── Desktop: Linux ───────────────────────────────────────────────────────────
  release-linux:
    name: Release Linux
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workdir: clients/desktop/src-tauri

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            clients/web/package-lock.json
            clients/desktop/package-lock.json

      - name: Install dependencies
        run: |
          npm ci --prefix clients/web
          npm ci --prefix clients/desktop

      - name: Build desktop app
        run: npm run build
        working-directory: clients/desktop

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            clients/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            clients/desktop/src-tauri/target/release/bundle/deb/*.deb

  # ── Android APK ─────────────────────────────────────────────────────────────
  release-android:
    name: Release Android APK
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust with Android targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workdir: clients/desktop/src-tauri

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK 27
        run: echo "y" | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "ndk;27.0.12077973"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            clients/web/package-lock.json
            clients/desktop/package-lock.json

      - name: Install dependencies
        run: |
          npm ci --prefix clients/web
          npm ci --prefix clients/desktop

      - name: Build web frontend
        run: npm run build
        working-directory: clients/web

      - name: Link Tauri CLI for Android Gradle build
        run: ln -sf ../node_modules/@tauri-apps/cli/tauri.js clients/desktop/src-tauri/tauri

      - name: Build Android APK
        run: ./node_modules/.bin/tauri android build --apk
        working-directory: clients/desktop
        env:
          NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/27.0.12077973

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: clients/desktop/src-tauri/gen/android/app/build/outputs/apk/**/*.apk

  # ── Publish GitHub Release ───────────────────────────────────────────────────
  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [release-macos, release-windows, release-linux, release-android]
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          prerelease: true
          generate_release_notes: true
          body: |
            ## Together — Pre-release (unsigned builds)

            Connect to your own self-hosted Together server. See the [self-hosting guide](https://github.com/jtjenkins/Together/blob/main/docs/self-hosting.md).

            | Platform | File |
            |---|---|
            | macOS (Apple Silicon) | `.dmg` |
            | Windows | `.msi` (recommended) or `.exe` |
            | Linux | `.AppImage` (any distro) or `.deb` (Debian/Ubuntu) |
            | Android | `.apk` (sideload) |

            ### Installation notes

            **macOS:** Right-click the `.dmg` → Open → "Open Anyway" to bypass Gatekeeper (unsigned).

            **Windows:** If SmartScreen appears, click "More info" → "Run anyway" (unsigned).

            **Android:** Enable "Install unknown apps" in settings, then open the `.apk`.

            **iOS:** Not available yet — requires App Store signing. Coming in a future release.
